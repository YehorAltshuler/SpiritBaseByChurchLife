---
import Layout from '../../layouts/Layout.astro';
import type { Post } from '../../types';

// Генерация статических путей для каждого поста (async для динамического импорта JSON)
export async function getStaticPaths() {
  // Динамический импорт JSON внутри функции (избегает bundling issues в static build)
  const rawPostsModule = await import('../../data/posts.json');
  const rawPosts = rawPostsModule.default || rawPostsModule;
  const posts: Post[] = rawPosts as Post[];

  return posts.map((post) => {
    const slug = post.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    return {
      params: { slug },
      props: { post },  // Передаём пост как prop для статического рендера
    };
  });
}

const { post } = Astro.props;  // Получаем пост из getStaticPaths props
if (!post) {
  return Astro.redirect('/404');
}

const date = new Date(post.timestamp * 1000).toLocaleDateString('ru-RU');
---

<Layout title={`${post.title} — SpiritBase`}>
  <article class="prose prose-lg max-w-none bg-white p-6 rounded-lg shadow-md">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">{post.title}</h1>
      <time datetime={post.timestamp.toString()} class="text-gray-500">{date}</time>
    </header>
    {post.media && <img src={post.media} alt={post.title} loading="lazy" class="my-4 rounded-lg w-full" loading="lazy" />}
    <div set:html={post.text.replace(/\n/g, '<br>')} />
  </article>
 <a href="/revelation" class="block mt-6 text-blue-500 hover:underline"> ← К списку Откровения </a>
</Layout>